name: Update Quality Report On README

on:
    workflow_dispatch:
    push:
        branches: [master]

jobs:
    update-code-coverage-on-readme:
        runs-on: [rnd-it-ubuntu]
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0 # Shallow clones should be disabled for a better relevancy of analysis
                  lfs: true
                  submodules: "recursive"
                  token: ${{secrets.ACTIONS_BOT_TOKEN}}

            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                  python-version: "3.9"

            - name: Run coverage in docker
              env:
                  DOCKER_BUILDKIT: 1
              run: |
                  docker build --target dev-coverage --tag docker_name:dev-coverage .
                  docker create --name=container_name docker_name:dev-coverage
                  docker cp container_name:/app/junit.xml .
                  docker cp container_name:/app/coverage.xml .
                  docker cp container_name:/app/htmlcov .
                  docker rm -v container_name
                  # docker run --rm -v "/tmp:/tmp" python:3.9-slim \
                  # python3 -m pip list

            - name: Calculate Code Coverage On Master
              id: coverage-comment
              uses: vcosmos-actions/pytest-coverage-comment@main
              with:
                  pytest-xml-coverage-path: ./coverage.xml
                  junitxml-path: ./junit.xml
                  hide-comment: true

            - name: Update SonarQube Scan Report
              uses: vcosmos-actions/sonarqube-scan-action@master
              env:
                  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
              with:
                  args: >
                      -Dsonar.projectKey=vcosmos_${{ github.event.repository.name }}
                      -Dsonar.sources=src/app/
                      -Dsonar.tests=src/tests/
                      -Dsonar.python.coverage.reportPaths=coverage.xml

            # - name: Update Code Coverage Summary Report On README
            #   run: |
            #       summay=${{ steps.coverage-comment.outputs.summaryReport }}
            #       summay="${summay%\"}"
            #       summay="${summay#\"}"
            #       sed -i "/<!-- Pytest Coverage Comment:Begin -->/,/<!-- Pytest Coverage Comment:End -->/ c \
            #       <!-- Pytest Coverage Comment:Begin -->\n${summay}\n<!-- Pytest Coverage Comment:End -->" ./README.md

            #- name: Commit Changes
            #  uses: vcosmos-actions/git-auto-commit-action@v4
            #  with:
            #      commit_message: ðŸ§ª Update Coverage on Readme
            #      commit_user_name: Mason Lin
            #      commit_user_email: mason.lin1@hp.com
            #      commit_author: Mason Lin <mason.lin1@hp.com>
            #      file_pattern: "README.md"

            # - name: Create Pull Request
            #   id: cpr
            #   uses: vcosmos-actions/create-pull-request@v4
            #   with:
            #       branch: update/coverage-report-readme
            #       title: ðŸ§ª Auto-update Update Coverage on README
            #       commit-message: ðŸ§ª Auto-update Update Coverage on README
            #       committer: Mason Lin <mason.lin1@hp.com>
            #       author: Mason Lin <mason.lin1@hp.com>
            #       body: |
            #           Update code coverage report of
            #           README.
            #       labels: |
            #           automated pr
            #           update
            #           readme
            #           code coverage
            #       delete-branch: true
            #       add-paths: |
            #           README.md

            # - name: Enable Pull Request Automerge
            #   if: steps.cpr.outputs.pull-request-operation == 'created'
            #   uses: vcosmos-actions/enable-pull-request-automerge@v2
            #   with:
            #       pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
            #       merge-method: squash
